


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="In this workshop, you learn how to build a serverless customer-facing microservices application demonstrating end-to-end authentication and authorization using Amazon Cognito, Amazon API Gateway, AWS Lambda, and all things AWS Identity and Access Management (IAM). You have the opportunity to build an end-to-end functional app with a secure identity provider showcasing user authentication patterns.">
      
      
        <link rel="canonical" href="https://serverless-idm.awssecworkshops.com/02-backend-auth/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>Module 2: Backend authorization - AWS Identity: Using Amazon Cognito for serverless consumer apps</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.63b94e9e.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-2-backend-authorization-with-amazon-api-gateway" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://serverless-idm.awssecworkshops.com/" title="AWS Identity: Using Amazon Cognito for serverless consumer apps" class="md-header-nav__button md-logo" aria-label="AWS Identity: Using Amazon Cognito for serverless consumer apps">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            AWS Identity: Using Amazon Cognito for serverless consumer apps
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Module 2: Backend authorization
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/aws-samples/amazon-cognito-identity-management-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/amazon-cognito-identity-management-workshop
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://serverless-idm.awssecworkshops.com/" title="AWS Identity: Using Amazon Cognito for serverless consumer apps" class="md-nav__button md-logo" aria-label="AWS Identity: Using Amazon Cognito for serverless consumer apps">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    AWS Identity: Using Amazon Cognito for serverless consumer apps
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/amazon-cognito-identity-management-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/amazon-cognito-identity-management-workshop
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../00-env-setup/" title="Module 0: Environment setup" class="md-nav__link">
      Module 0: Environment setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-user-auth/" title="Module 1: User flows" class="md-nav__link">
      Module 1: User flows
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 2: Backend authorization
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 2: Backend authorization" class="md-nav__link md-nav__link--active">
      Module 2: Backend authorization
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#launch-the-serverless-api-backend" class="md-nav__link">
    Launch the Serverless API backend
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integrate-your-api" class="md-nav__link">
    Integrate your API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validate-api-functionality-and-integration" class="md-nav__link">
    Validate API functionality and integration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enable-api-gateway-authorization-with-cognito" class="md-nav__link">
    Enable API Gateway authorization with Cognito
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-of-module-2" class="md-nav__link">
    End of Module 2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-extensions" class="md-nav__link">
    Optional extensions
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../03-iam-auth/" title="Module 3: Temporary AWS credentials" class="md-nav__link">
      Module 3: Temporary AWS credentials
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../04-clean-up/" title="Module 4: Clean up" class="md-nav__link">
      Module 4: Clean up
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#launch-the-serverless-api-backend" class="md-nav__link">
    Launch the Serverless API backend
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integrate-your-api" class="md-nav__link">
    Integrate your API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#validate-api-functionality-and-integration" class="md-nav__link">
    Validate API functionality and integration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enable-api-gateway-authorization-with-cognito" class="md-nav__link">
    Enable API Gateway authorization with Cognito
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#end-of-module-2" class="md-nav__link">
    End of Module 2
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-extensions" class="md-nav__link">
    Optional extensions
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/amazon-cognito-identity-management-workshop/edit/master/docs/02-backend-auth.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-2-backend-authorization-with-amazon-api-gateway">Module 2 <small>Backend authorization with Amazon API Gateway</small></h1>
<p><strong>Time</strong>: 30 minutes</p>
<p>In this module, you will add a serverless backend to your Wild Rydes application leveraging <a href="https://aws.amazon.com/api-gateway/" target="_blank">Amazon API Gateway</a> and <a href="https://aws.amazon.com/lambda/" target="_blank">AWS Lambda</a>. You will then enable authentication and authorization on your API to secure the backend to only accept valid, authorized requests.</p>
<h2 id="architecture">Architecture</h2>
<p>Building on Module 1, this module will add a Serverless backend built using Amazon API Gateway and AWS Lambda. For persistence, you will use Amazon DynamoDB as a NoSQL data store. All of the above services are serverless so you can seamlessly scale your application as your demands grow. After creating the API, we will integrate our client application to call it via the AWS Amplify library.</p>
<p><img alt="Module 2 architecture" src="../images/wildrydes-module2-architecture.png" /></p>
<h2 id="launch-the-serverless-api-backend">Launch the Serverless API backend</h2>
<p>You will be creating your Serverless API built with Amazon API Gateway, AWS Lambda, and Amazon DynamoDB via a CloudFormation template. Since this workshop is focused on authentication and authorization, this template will create the backend infrastructure, but not enable any security settings and the rest of the module will enable and configure such settings.</p>
<p>Create a new WildRydes Serverless Backend stack by launching a CloudFormation stack based on the <strong>serverless-backend.yaml</strong> file in the templates folder.</p>
<p>This WildRydes backend CloudFormation template will provision your API Gateway deployment with Lambda functions for compute, a DynamoDB database for persistence, and an S3 bucket for photo uploads which will be used in module 3. Additionally, the necessary function invocation permissions and execution role for the Lambda function will also be provisioned.</p>
<table>
<thead>
<tr>
<th>Region</th>
<th>Deploy</th>
</tr>
</thead>
<tbody>
<tr>
<td>us-east-1 (N. Virginia)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=serverless-idm-backend&templateURL=https://sa-security-specialist-workshops-us-east-1.s3.amazonaws.com/serverless-idm/serverless-backend.yaml" target="_blank"><img alt="Launch Cloud9 in us-east-1" src="../images/deploy-to-aws.png" /></a></td>
</tr>
<tr>
<td>us-east-2 (Ohio)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/new?stackName=serverless-idm-backend&templateURL=https://sa-security-specialist-workshops-us-east-2.s3.us-east-2.amazonaws.com/serverless-idm/serverless-backend.yaml" target="_blank"><img alt="Launch Cloud9 in us-east-2" src="../images/deploy-to-aws.png" /></td>
</tr>
<tr>
<td>us-west-2 (Oregon)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/new?stackName=serverless-idm-backend&templateURL=https://sa-security-specialist-workshops-us-west-2.s3-us-west-2.amazonaws.com/serverless-idm/serverless-backend.yaml" target="_blank"><img alt="Launch Cloud9 in us-west-2" src="../images/deploy-to-aws.png" /></td>
</tr>
</tbody>
</table>
<ol>
<li>
<p>Click the <strong>Deploy to AWS</strong> button above.  This will automatically take you to the console to run the template.</p>
</li>
<li>
<p>The <strong>Specify an Amazon S3 template URL</strong> is already selected and the template URL is automatically added.  Click <strong>Next</strong>.</p>
</li>
<li>
<p>On the <strong>Specify Details</strong> click <strong>Next</strong>. </p>
</li>
<li>
<p>On the <strong>Options</strong> click <strong>Next</strong> (leave everything on this page as the default).</p>
</li>
<li>
<p>On the Review page, choose to <strong>Acknowledge that the CloudFormation template may create IAM resources with custom names</strong>, review the summary details, and then click <strong>Create stack</strong>.</p>
<div class="admonition warning">
<p class="admonition-title">It will take a few minutes for the Stack to create.</p>
<p>Choose the <strong>Stack Info</strong> tab to go to the overall stack status page and wait until the stack is fully launched and shows a status of <em>CREATE_COMPLETE</em>. Click the refresh icon periodically to see progress update.</p>
</div>
</li>
<li>
<p>With the <strong>serverless-idm-backend</strong> stack selected, click on the <strong>Outputs</strong> tab and copy the value shown for the <strong>WildRydesApiInvokeUrl</strong> to your Cloud9 scratchpad editor tab.</p>
</li>
</ol>
<h2 id="integrate-your-api">Integrate your API</h2>
<p>Now that you have created our Serverless API, you need to update your Wild Rydes web application to integrate with it. You will leverage the AWS Amplify client library to make API calls and inject security seamlessly to support your authentication and authorization scenarios.</p>
<p>First, you need to update the <strong>/website/src/amplify-config.js</strong> file to include the following:</p>
<ul>
<li><strong>endpoint:</strong> Your new API Gateway endpoint.</li>
<li><strong>region:</strong> Your region.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Do NOT change the name <code>WildRydesAPI</code>.</p>
</div>
<div class="codehilite"><pre><span></span><code><span class="err">EXAMPLE OUTPUT - DO NOT COPY</span>
<span class="c">API: {</span>
<span class="c">    endpoints: [</span>
<span class="c">        {</span>
<span class="c">            name: &#39;WildRydesAPI&#39;,</span>
<span class="c">            endpoint: &#39;https://1ngrgqjt6c.execute-api.us-east-1.amazonaws.com/prod&#39;,</span>
<span class="c">            region: &#39;us-east-2&#39;</span>
<span class="c">        }</span>
<span class="c">    ]</span>
<span class="err">},</span>
</code></pre></div>


<p>Next, you need to enable the hasAPI method by uncommenting its code within <strong>/website/src/pages/MainApp.js</strong>.</p>
<div class="codehilite"><pre><span></span><code><span class="nx">hasApi</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">api</span> <span class="o">=</span> <span class="nx">awsConfig</span><span class="p">.</span><span class="nx">API</span><span class="p">.</span><span class="nx">endpoints</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">v</span> <span class="p">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">endpoint</span> <span class="o">!==</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">api</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<p>Finally, within the same file, we will implement the API request for a ride as a POST request to our API which sends a body containing the requested latitude and longitude as the pickup location. Update the <strong>getData()</strong> method to be as follows:</p>
<div class="codehilite"><pre><span></span><code><span class="nx">async</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">pin</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">apiRequest</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">PickupLocation</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">Longitude</span><span class="o">:</span> <span class="nx">pin</span><span class="p">.</span><span class="nx">longitude</span><span class="p">,</span>
            <span class="nx">Latitude</span><span class="o">:</span> <span class="nx">pin</span><span class="p">.</span><span class="nx">latitude</span>
        <span class="p">}</span>
        <span class="p">},</span>
        <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
        <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1">// To be updated</span>
        <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;API Request:&#39;</span><span class="p">,</span> <span class="nx">apiRequest</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">await</span> <span class="nx">API</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">apiName</span><span class="p">,</span> <span class="nx">apiPath</span><span class="p">,</span> <span class="nx">apiRequest</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>


<h2 id="validate-api-functionality-and-integration">Validate API functionality and integration</h2>
<p>Now that you've integrated code changes to call your new Serverless API, you should test the end-to-end user experience to ensure the application is working correctly. The API currently requires no authentication so any request will currently be accepted until we enable required authentication.</p>
<ol>
<li>Go back to the home page of the Wild Rydes application.</li>
<li>
<p>Click on <strong>Giddy up</strong> to sign in.</p>
<p><img alt="Giddy up!" src="../images/giddy-up.png" />
3. Once signed in, click anywhere on the map to indicate a pickup location, then select the <strong>Request</strong> button to call your ride.</p>
</li>
</ol>
<p>You should be informed of your unicorn's arrival momentarily.</p>
<h2 id="enable-api-gateway-authorization-with-cognito">Enable API Gateway authorization with Cognito</h2>
<p>Amazon API Gateway can use the JSON Web tokens (JWT) returned by Cognito User Pools to authenticate API calls. In this step, you'll configure an authorizer for your API to use the user pool you created in module 1.</p>
<p>Since Cognito User Pools implements <a href="https://openid.net/connect/" target="_blank">OpenID Connect</a> JSON web tokens, API Gateway is able to compare the signature of an access or identity token against the known public keys of the Cognito User Pool which allows verification and authentication to happen without having to write additional code in your application.</p>
<p>In the Amazon API Gateway console, create a new Cognito user pool authorizer for your API. Configure it to use the user pool that you created in the previous module. You can test the configuration in the console by copying and pasting the identity token printed to the console after you log in via the <code>/signin</code> path of your current website. Once setup, you will change your application's code to send the proper JSON web token with its API requests to authenticate.</p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/apigateway/home?" target="_blank">Amazon API Gateway</a> console.</p>
</li>
<li>
<p>Choose the API named <strong>WildRydes</strong>.</p>
</li>
<li>
<p>Under your newly created API, choose <strong>Authorizers</strong>.</p>
<p><img alt="API Authorizer Settings" src="../images/apigateway-authorizer-settings.png" /></p>
</li>
<li>
<p>Chose <strong>Create New Authorizer</strong>.</p>
</li>
<li>
<p>Enter <strong>WildRydes</strong> for the Authorizer name.</p>
</li>
<li>
<p>Select <strong>Cognito</strong> for the type.</p>
</li>
<li>
<p>In the Region drop-down under <strong>Cognito User Pool</strong>, select the Region where you created your Cognito user pool in the last module (by default the current region should be selected).</p>
</li>
<li>
<p>Select <strong>WildRydes</strong> (or the name you gave your user pool) from the dropdown for the <strong>Cognito User Pool</strong> input.</p>
</li>
<li>
<p>Enter <strong>Authorization</strong> for the <strong>Token Source</strong>.</p>
</li>
<li>
<p>Leave <em>Token Validation</em> blank without editing.</p>
</li>
<li>
<p>Choose <strong>Create</strong>.</p>
<p><img alt="Create user pool authorizer screenshot" src="../images/create-user-pool-authorizer.png" /></p>
</li>
</ol>
<p><strong>Verify your authorizer configuration</strong></p>
<ol>
<li>
<p>In a different browser tab, return to your Wild Rydes application and  sign-in if you're not already signed in. After signing in, you should be redirected to <em>/app</em>. </p>
</li>
<li>
<p>Open your <a href="https://support.airtable.com/hc/en-us/articles/232313848-How-to-open-the-developer-console" target="_blank">browser's developer console</a> and browse to the console log output section.</p>
</li>
<li>
<p>Look for the console log to say <strong>Cognito User Identity Token:</strong> and a long string beneath the message.</p>
</li>
<li>
<p>Copy the long string to your clipboard without the intro message. You will need to copy across multiple lines to fully copy the token in its entirety.</p>
</li>
<li>
<p>Go back to previous tab where you have just finished creating the Authorizer.</p>
</li>
<li>
<p>Click <strong>Test</strong> at the bottom of the card for the authorizer.</p>
</li>
<li>
<p>Paste the auth token into the <strong>Authorization Token</strong> field in the popup dialog.</p>
<p><img alt="Test Authorizer screenshot" src="../images/apigateway-test-authorizer.png" /></p>
</li>
<li>
<p>Click <strong>Test</strong> button and verify that the response code is 200 and that you see the claims for your user displayed. Since this is the identity token, the user's attributes are encoded within the JWT as claims which can be read parsed programatically.</p>
<div class="admonition warning">
<p class="admonition-title">If you do not receive successful test results as shown below, do not proceed until you're able to validate the authorizer is configured properly and passes this test.</p>
</div>
<p><img alt="Successful Authorizer test screenshot" src="../images/apigateway-authorizer-test.png" /></p>
</li>
</ol>
<p><strong>Require Cognito authentication for API Gateway</strong></p>
<ol>
<li>
<p>Browse to <strong>Resources</strong> while within your Wild Rydes API in the API Gateway console.</p>
</li>
<li>
<p>Select the <strong>POST</strong> method under the <em>/ride</em> resource path.</p>
</li>
<li>
<p>Choose <strong>Method Request</strong></p>
<p><img alt="Method Request Selection" src="../images/apigateway-method-request-settings.png" /></p>
</li>
<li>
<p>Choose the pencil icon next to <strong>Authorization</strong> to edit the setting.</p>
</li>
<li>
<p>Select your new Cognito Authorizer from the list of options presented.</p>
<div class="admonition tip">
<p class="admonition-title">If you don't see this option listed, <strong>Reload</strong> the browser page then this authorizer option should appear in the drop-down list.</p>
</div>
<p><img alt="API Gateway Authorizer Selection" src="../images/apigateway-authorizer-cognito-selection.png" /></p>
</li>
<li>
<p><strong>Save</strong> your selection by clicking the checkmark icon next to the drop down.</p>
<p><img alt="API Gateway Authorizer Confirmation" src="../images/apigateway-authorizer-cognito-confirmation.png" /></p>
</li>
<li>
<p>Next, choose the <strong>Actions</strong> button at the top of the resources list.</p>
</li>
<li>
<p>Choose <strong>Deploy API</strong> from the list of options presented.</p>
</li>
<li>
<p>For deployment stage, select <strong>prod</strong> then click <strong>Deploy</strong>.</p>
</li>
<li>
<p>You've now successfully deployed your new authentication integration to your API's production environment.</p>
</li>
</ol>
<p><strong>Configure your Wild Rydes web app to authenticate API requests</strong></p>
<p>Now that you've deployed the new authorizer configuration to production, all API requests must be authenticated to be processed.</p>
<ol>
<li>
<p>Return to your Wild Rydes app, sign in at <em>/signin</em> if necessary, and attempt to request a ride.</p>
</li>
<li>
<p>You should receive an <em>Error finding unicorn</em>. If you open the developer console, you will see that we received a HTTP 401 error, which means it was an unauthorized request. To authenticate our requests properly, we need to send an Authorization header.</p>
<div class="admonition tip">
<p class="admonition-title">If at first your requests go through without any errors, try requesting a ride again in 30-60 seconds to allow the API Gateway changes to fully propagate.</p>
</div>
</li>
<li>
<p>Go back to Cloud9 and open the <strong>/website/src/pages/MainApp.js</strong> files.</p>
</li>
<li>
<p>Browse down to the <strong>getData</strong> method you previously updated. You will notice that the headers for the request currently include a blank <em>Authorization</em> header.</p>
</li>
<li>
<p>Replace your current <em>getData</em> method with the following code which sends your user's Cognito identity token, encoded as a JSON web token, in the <em>Authorization</em> header with every request.</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>    <span class="nx">async</span> <span class="nx">getData</span><span class="p">(</span><span class="nx">pin</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">const</span> <span class="nx">apiRequest</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">body</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">PickupLocation</span><span class="o">:</span> <span class="p">{</span>
                <span class="nx">Longitude</span><span class="o">:</span> <span class="nx">pin</span><span class="p">.</span><span class="nx">longitude</span><span class="p">,</span>
                <span class="nx">Latitude</span><span class="o">:</span> <span class="nx">pin</span><span class="p">.</span><span class="nx">latitude</span>
            <span class="p">}</span>
            <span class="p">},</span>
            <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">idToken</span><span class="p">,</span>
            <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;API Request:&#39;</span><span class="p">,</span> <span class="nx">apiRequest</span><span class="p">);</span>
        <span class="k">return</span> <span class="nx">await</span> <span class="nx">API</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">apiName</span><span class="p">,</span> <span class="nx">apiPath</span><span class="p">,</span> <span class="nx">apiRequest</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>


<p>Allow the application to refresh, sign-in again, and request a ride.</p>
<p>The unicorn ride request should be fulfilled as before now. To see the full request headers which were sent, look at the developer console for an <em>API Request</em> informational message which includes the API Request details once expanded, including the full headers and body of the request.</p>
<p><img alt="Cognito Authorizer Request Console Log" src="../images/cognito-authorizer-request-console-log.png" /></p>
<p>If the API now invokes correctly and application functions as expected summoning unicorns, you may proceed to the next module.</p>
<h2 id="end-of-module-2">End of Module 2</h2>
<p>Once you have finished setting up the backend authorization please wait for the instructions from the presenter to move on to the next module (unless you're running this on your own).  </p>
<hr />
<h2 id="optional-extensions">Optional extensions</h2>
<p>If you've finished Module 2 early and to try out some alternative authorzation methods, feel free to run through the optional extension:</p>
<ul>
<li><strong>Extension 1</strong>: <a href="../02-backend-auth-iam/">API Gateway Authorization with AWS IAM</a></li>
</ul>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../01-user-auth/" title="Module 1: User flows" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 1: User flows
              </div>
            </div>
          </a>
        
        
          <a href="../03-iam-auth/" title="Module 3: Temporary AWS credentials" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 3: Temporary AWS credentials
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            <a href="https://aws.amazon.com/privacy/" target="_blank">Privacy</a> | <a href="https://aws.amazon.com/terms/" target="_blank">Site terms</a> | &copy; 2020, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M280.37 148.26L96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V300L295.67 148.26a12.19 12.19 0 00-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19 0 0115.3 0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M466.5 83.7l-192-80a48.15 48.15 0 00-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>