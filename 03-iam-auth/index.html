


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="In this workshop, you learn how to build a serverless customer-facing microservices application demonstrating end-to-end authentication and authorization using Amazon Cognito, Amazon API Gateway, AWS Lambda, and all things AWS Identity and Access Management (IAM). You have the opportunity to build an end-to-end functional app with a secure identity provider showcasing user authentication patterns.">
      
      
        <link rel="canonical" href="https://serverless-idm.awssecworkshops.com/03-iam-auth/">
      
      
        <meta name="author" content="aws-security-workshops@amazon.com">
      
      <link rel="shortcut icon" href="../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.5.6">
    
    
      
        <title>Module 3: Temporary AWS credentials - AWS Identity: Using Amazon Cognito for serverless consumer apps</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.63b94e9e.min.css">
      
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/custom.css">
    
    
      
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#module-3-retrieving-and-using-temporary-aws-credentials" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://serverless-idm.awssecworkshops.com/" title="AWS Identity: Using Amazon Cognito for serverless consumer apps" class="md-header-nav__button md-logo" aria-label="AWS Identity: Using Amazon Cognito for serverless consumer apps">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            AWS Identity: Using Amazon Cognito for serverless consumer apps
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Module 3: Temporary AWS credentials
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/aws-samples/amazon-cognito-identity-management-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/amazon-cognito-identity-management-workshop
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://serverless-idm.awssecworkshops.com/" title="AWS Identity: Using Amazon Cognito for serverless consumer apps" class="md-nav__button md-logo" aria-label="AWS Identity: Using Amazon Cognito for serverless consumer apps">
      
  <img src="../assets/images/aws_smile_logo.png" alt="logo">

    </a>
    AWS Identity: Using Amazon Cognito for serverless consumer apps
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aws-samples/amazon-cognito-identity-management-workshop/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aws-samples/amazon-cognito-identity-management-workshop
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../00-env-setup/" title="Module 0: Environment setup" class="md-nav__link">
      Module 0: Environment setup
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../01-user-auth/" title="Module 1: User flows" class="md-nav__link">
      Module 1: User flows
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../02-backend-auth/" title="Module 2: Backend authorization" class="md-nav__link">
      Module 2: Backend authorization
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Module 3: Temporary AWS credentials
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="./" title="Module 3: Temporary AWS credentials" class="md-nav__link md-nav__link--active">
      Module 3: Temporary AWS credentials
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-s3-bucket-for-use-with-aws-amplify" class="md-nav__link">
    Setup S3 bucket for use with AWS Amplify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-iam-permissions" class="md-nav__link">
    Configure IAM permissions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#update-application-to-upload-photos" class="md-nav__link">
    Update application to upload photos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-profile-picture-links-in-cognito-user-pools-profile" class="md-nav__link">
    Store profile picture links in Cognito User Pools profile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-picture-attribute-in-user-pools" class="md-nav__link">
    View the picture attribute in User Pools
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../04-clean-up/" title="Module 4: Clean up" class="md-nav__link">
      Module 4: Clean up
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contribute/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../license/" title="License" class="md-nav__link">
      License
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    Architecture
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-s3-bucket-for-use-with-aws-amplify" class="md-nav__link">
    Setup S3 bucket for use with AWS Amplify
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configure-iam-permissions" class="md-nav__link">
    Configure IAM permissions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#update-application-to-upload-photos" class="md-nav__link">
    Update application to upload photos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#store-profile-picture-links-in-cognito-user-pools-profile" class="md-nav__link">
    Store profile picture links in Cognito User Pools profile
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#view-the-picture-attribute-in-user-pools" class="md-nav__link">
    View the picture attribute in User Pools
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aws-samples/amazon-cognito-identity-management-workshop/edit/master/docs/03-iam-auth.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  
                
                
                <h1 id="module-3-retrieving-and-using-temporary-aws-credentials">Module 3 <small>Retrieving and using temporary AWS credentials</small></h1>
<p><strong>Time</strong>: 15 minutes</p>
<p>In this module, you will expand your Wild Rydes application by enabling a profile management and profile photo management capabilities. Amazon Cognito will be used to store your user's profile information and custom attributes whereas <a href="https://aws.amazon.com/s3/" target="_blank">Amazon S3</a> will store your user's profile pictures, with a link to the photo only being stored in the user's profile directly.</p>
<h2 id="architecture">Architecture</h2>
<p>Building on Modules 1 and 2, this module will add photo storage and management via an Amazon S3 bucket. For AWS resource access from a web application, Amazon Cognito will issue not only JWTs as we saw earlier, but then also allow users to assume an IAM role from within the application. This AWS IAM role will then allow their application to securely connect to upload and download photos from S3 (though any other AWS API would also work with this capability). To secure access to the photo storage and bucket, you will leverage IAM policies for fine-grained control.</p>
<p><img alt="Module 3 architecture" src="../images/wildrydes-module3-architecture.png" /></p>
<h2 id="setup-s3-bucket-for-use-with-aws-amplify">Setup S3 bucket for use with AWS Amplify</h2>
<p>You will need to configure AWS Amplify to securely store profile images in an S3 bucket. To save time, the Serverless Backend CloudFormation template that created the serverless backend API for this workshop also created an S3 bucket for this purpose with the cross-origin resource sharing (CORS) settings already set. You just need to associate this bucket with your application's code.</p>
<p>To do this you'll browse to your CloudFormation stack created in the earlier modules and find the name of the S3 bucket under Outputs. Once you have the name you'll modify your <strong>amplify-config.js</strong> file again and update the storage section with the bucket's name and region.</p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/cloudformation/home?" target="_blank">AWS CloudFormation</a> console.</p>
</li>
<li>
<p>In the CloudFormation console, click on your Wild Rydes stack name <strong>serverless-idm-backend</strong>.</p>
</li>
<li>
<p>Click on the <strong>Outputs</strong> tab.</p>
</li>
<li>
<p>Copy your bucket name to your clipboard. It is the name shown under Value for the key called <strong>WildRydesProfilePicturesBucket</strong>.</p>
</li>
<li>
<p>Next, return to your Cloud9 IDE and open the file <strong>/website/src/amplify-config.js</strong>.</p>
</li>
<li>
<p>Fill in values for both the bucket name, which you just copied, as well as the region where your CloudFormation template was launched</p>
</li>
<li>
<p>Your final structure for the storage configuration of <strong>amplify-config.js</strong> should look like the following.</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="err">EXAMPLE OUTPUT - DO NOT COPY</span>
<span class="c">Storage: {</span>
<span class="c">    bucket: &#39;wildrydes-profilepicturesbucket-1rmvuic97osxd&#39;,</span>
<span class="c">    region: &#39;us-east-2&#39;</span>
<span class="err">}</span>
</code></pre></div>


<h2 id="configure-iam-permissions">Configure IAM permissions</h2>
<p>Though you could now attempt uploading photos via AWS Amplify, Amplify would use your Cognito Identity Pool roles that were created in module 1 which currently has no policies associated so you would not have access to the S3 bucket created. You need to next update your roles to have policies that grant access to your S3 photo bucket.</p>
<p>Browse to the IAM console and find your Cognito Identity Pool's authenticated user role. Create an in-line policy on this role which provides for <a href="https://aws-amplify.github.io/docs/js/storage#file-access-levels" target="_blank">S3 bucket protected and private-level access</a> per-user by leveraging IAM policy variables. </p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/iam/home?" target="_blank">AWS IAM</a> console.</p>
</li>
<li>
<p>Choose <strong>Roles</strong>.</p>
</li>
<li>
<p>Search for <strong>WildRydes</strong> to find the two roles which were created by Cognito Identity Pools when you created the Identity Pool in module one. </p>
<div class="admonition info">
<p class="admonition-title">Should you not be able to find the roles here, you can alternatively go to the <strong>Cognito Federated Identities</strong> console, find the correct identity pool, then click <strong>Edit Identity Pool</strong> in the top-right corner to see the roles listed. Each identity pool has both an Unauthenticated user role and an Authenticated user role.</p>
</div>
</li>
<li>
<p>Select the <strong>Auth* role</strong> for your authenticated users.</p>
<p><img alt="IAM WildRydes Auth Role Selction" src="../images/iam-wildrydes-role-selection.png" /></p>
</li>
<li>
<p>Choose <strong>Add inline policy</strong> on the right-hand side to create a new inline policy associated to this IAM role.</p>
<p><img alt="Add inline policy to WildRydes auth role" src="../images/iam-wildrydes-auth-role-add-inline-policy.png" /></p>
</li>
<li>
<p>Choose the <strong>JSON</strong> tab to allow you to free-form edit the new policy.</p>
</li>
<li>
<p>Paste the following IAM policy statements for S3 access. After pasting, you will need to go <strong>replace the bucket name</strong> listed in all caps with your bucket name (a total of 4 times).</p>
<div class="admonition tip">
<p class="admonition-title">Be sure to leave the parts of the resource names before and after the replacement value alone and not accidentally modify them.</p>
<p>The following policy makes use of IAM policy variables where <strong>${aws:userid}</strong> represents the current authenticated user's unique Cognito identity ID. This policy's effective permissions will allow all authenticated users to read objects from the root of the bucket and any /protected path, but only allow users to read their own private sub-path and write to their sub-path within the protected path. These are default paths that are integrated with AWS Amplify to easily set <a href="https://aws-amplify.github.io/docs/js/storage#file-access-levels" target="_blank">file access levels</a>.</p>
</div>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;Version&quot;</span><span class="p">:</span> <span class="s2">&quot;2012-10-17&quot;</span><span class="p">,</span>
    <span class="nt">&quot;Statement&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;s3:PutObject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:GetObjectVersion&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:DeleteObject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:DeleteObjectVersion&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:s3:::REPLACE_WITH_YOUR_BUCKET_NAME/private/${aws:userid}/*&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:GetObjectVersion&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:s3:::REPLACE_WITH_YOUR_BUCKET_NAME/protected/*&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;s3:PutObject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:DeleteObject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:DeleteObjectVersion&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:s3:::REPLACE_WITH_YOUR_BUCKET_NAME/protected/${aws:userid}/*&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;Effect&quot;</span><span class="p">:</span> <span class="s2">&quot;Allow&quot;</span><span class="p">,</span>
            <span class="nt">&quot;Action&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;s3:PutObject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:GetObject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:GetObjectVersion&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:DeleteObject&quot;</span><span class="p">,</span>
                <span class="s2">&quot;s3:DeleteObjectVersion&quot;</span>
            <span class="p">],</span>
            <span class="nt">&quot;Resource&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:s3:::REPLACE_WITH_YOUR_BUCKET_NAME/public/*&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>


<ol>
<li>
<p>Choose <strong>Review policy</strong>.</p>
</li>
<li>
<p>Name the policy <strong>WildRydes-S3Access</strong>.</p>
</li>
<li>
<p>After reviewing for accuracy and any syntax errors, choose <strong>Create policy</strong>.</p>
</li>
</ol>
<h2 id="update-application-to-upload-photos">Update application to upload photos</h2>
<p>Now that your IAM policies and Amplify SDK are initialized, you will be able to upload photos and render S3 photos with minimal code using Amplify's built-in UI components. S3 image is the component used to both render image objects for a React application, as well as embeding an image picker to help with uploads.</p>
<p>Authenticate in the Wild Rydes app if you're not already logged in, then browse to the <em>/profile</em> path. You will see that your Cognito User Pool attributes are being read dynamically by the system. Next, you will add an <a href="https://aws-amplify.github.io/docs/js/storage#s3image" target="_blank">image picker</a> from AWS Amplify to render a UI component for uploading and displaying photos stored in S3. These profile photos will be used to personalize the rider experience so unicorns know who to look for when picking up passengers.</p>
<ol>
<li>
<p>After logging in to Wild Rydes (if you're not authenticated already), browse to the <strong>/profile</strong> path.</p>
</li>
<li>
<p>You should see that your e-mail address and phone number you registered with are displayed which are all of your currently populated attributes.</p>
</li>
<li>
<p>Open your Cloud9 IDE environment and open the file at <strong>/website/src/pages/Profile.js</strong>.</p>
</li>
<li>
<p><strong>Uncomment</strong> the line that says <strong>S3Image</strong> (remove /* */).  It should end up looking like the following: </p>
<p><code>{ &lt;S3Image imgKey={this.state.image_key} onLoad={(url) =&gt; this.onImageLoad(url)} picker/&gt; }</code></p>
<p>This instantiates an Amplify UI component for React apps for image rendering and uploading and only requires this single line of code.</p>
</li>
<li>
<p><strong>Save</strong> the file.</p>
</li>
<li>
<p>Go back to the Wild Rydes app and visit the <strong>/profile</strong> path after logging in. You should now be able to upload photos with the new image picker.</p>
</li>
</ol>
<h2 id="store-profile-picture-links-in-cognito-user-pools-profile">Store profile picture links in Cognito User Pools profile</h2>
<p>With your image uploads now working, all will work as expected until you close your browser, but at that point the reference between your user profile and your profile picture will be lost. To fix this, you will leverage a Cognito User Pools user attribute called <em>picture</em> to persist the S3 object key so the same image can be loaded upon each login and persisted to be shown to the unicorns when you request a ride. You will need to update <em>/website/src/pages/Profile.js</em> and a method called <em>onImageLoad</em> to make this possible.</p>
<p>Implement a method to persist the images uploaded to the current user's Cognito <em>picture</em> attribute each time the image is changed.</p>
<ol>
<li>
<p>Open your Cloud9 IDE environment and open the file at <strong>/website/src/pages/Profile.js</strong>.</p>
</li>
<li>
<p>The S3Image UI component has a built-in method called <strong>onImageLoad</strong> which provides in its invocation the full URL of any image uploaded. We will make use of this built-in function to persist your image URLs out to Cognito.</p>
</li>
<li>
<p>Replace the existing <strong>onImageLoad</strong> function with the following code:</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="err">async onImageLoad(url) {</span>
<span class="err">    if (!this.state.user.getSession) { return };</span>
<span class="err">    console.log(&#39;Profile Picture URL:&#39;, url);</span>
<span class="err">    try {</span>
<span class="err">        let result = await Auth.updateUserAttributes(this.state.user, {</span>
<span class="err">            &#39;picture&#39;: this.state.image_key</span>
<span class="err">        });</span>
<span class="err">        console.log(result);</span>
<span class="err">    } catch (ex) {</span>
<span class="err">        console.error(&#39;Attribute update error:&#39;, ex);</span>
<span class="err">    }</span>
<span class="err">}</span>
</code></pre></div>


<p>Now with this new method in place, upload a new photo after logging into Wild Rydes then close your browser. Open a new window and try logging in again. Your photo should load as it did previously.</p>
<h2 id="view-the-picture-attribute-in-user-pools">View the picture attribute in User Pools</h2>
<p>Lastly, you can view your user profile in User Pools to ensure the picture attribute has been set.</p>
<ol>
<li>
<p>Open the <a href="https://console.aws.amazon.com/cognito/home?" target="_blank">Amazon Cognito</a> console.</p>
</li>
<li>
<p>Click on the <strong>WildRydes</strong> User Pool.</p>
</li>
<li>
<p>Click <strong>Users and groups</strong>.</p>
</li>
<li>
<p>Click on your user and view the attributes.</p>
</li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>Congratulations! You've completed the Wild Rydes Auth workshop. We hope that this time and interactive learning has been valuable for you. This workshop was an adaptation of an existing workshop located in the aws-serverless-workshops <a href="https://github.com/aws-samples/aws-serverless-workshops" target="_blank">repo</a>.</p>
<p>Please proceed to the next module to run through the clean up steps to ensure you decommission all resources spun up during the workshop today.</p>
<p>Thank you for participating!</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../02-backend-auth/" title="Module 2: Backend authorization" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Module 2: Backend authorization
              </div>
            </div>
          </a>
        
        
          <a href="../04-clean-up/" title="Module 4: Clean up" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Module 4: Clean up
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://awssecworkshops.com" target="_blank" rel="noopener" title="awssecworkshops.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M280.37 148.26L96 300.11V464a16 16 0 0016 16l112.06-.29a16 16 0 0015.92-16V368a16 16 0 0116-16h64a16 16 0 0116 16v95.64a16 16 0 0016 16.05L464 480a16 16 0 0016-16V300L295.67 148.26a12.19 12.19 0 00-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 00-12-12h-56a12 12 0 00-12 12v72.61L318.47 43a48 48 0 00-61 0L4.34 251.47a12 12 0 00-1.6 16.9l25.5 31A12 12 0 0045.15 301l235.22-193.74a12.19 12.19 0 0115.3 0L530.9 301a12 12 0 0016.9-1.6l25.5-31a12 12 0 00-1.7-16.93z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M466.5 83.7l-192-80a48.15 48.15 0 00-36.9 0l-192 80C27.7 91.1 16 108.6 16 128c0 198.5 114.5 335.7 221.5 380.3 11.8 4.9 25.1 4.9 36.9 0C360.1 472.6 496 349.3 496 128c0-19.4-11.7-36.9-29.5-44.3zM256.1 446.3l-.1-381 175.9 73.3c-3.3 151.4-82.1 261.1-175.8 307.7z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/awssecurityinfo?lang=en" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://aws.amazon.com/blogs/security/" target="_blank" rel="noopener" title="aws.amazon.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M400 32H48C21.49 32 0 53.49 0 80v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zM112 416c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm157.533 0h-34.335c-6.011 0-11.051-4.636-11.442-10.634-5.214-80.05-69.243-143.92-149.123-149.123-5.997-.39-10.633-5.431-10.633-11.441v-34.335c0-6.535 5.468-11.777 11.994-11.425 110.546 5.974 198.997 94.536 204.964 204.964.352 6.526-4.89 11.994-11.425 11.994zm103.027 0h-34.334c-6.161 0-11.175-4.882-11.427-11.038-5.598-136.535-115.204-246.161-251.76-251.76C68.882 152.949 64 147.935 64 141.774V107.44c0-6.454 5.338-11.664 11.787-11.432 167.83 6.025 302.21 141.191 308.205 308.205.232 6.449-4.978 11.787-11.432 11.787z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.d1f5a259.min.js"></script>
      <script src="../assets/javascripts/bundle.d5fec882.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.fae956e7.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>